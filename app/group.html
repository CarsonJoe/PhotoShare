<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Carson's Photos</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="site-header">
      <h1 class="site-title"><a href="index.html">Carson's Photos</a></h1>
      <nav class="site-nav">
        <span id="groupCrumb" class="crumb"></span>
      </nav>
    </header>

    <main class="container">
      <section>
        <h2 id="groupTitle" class="section-title"></h2>
        <div id="photos" class="grid photos-grid" aria-live="polite"></div>
        <div id="emptyState" class="empty" hidden>
          <p>Album not found or has no photos.</p>
        </div>
      </section>
    </main>

    <div id="lightbox" class="lightbox" hidden>
      <button class="lb-btn lb-close" aria-label="Close">×</button>
      <button class="lb-btn lb-prev" aria-label="Previous">‹</button>
      <img id="lightboxImage" alt="Full size" />
      <div class="lb-caption">
        <span id="lbName"></span>
        <a id="lbDownload" class="download" download>Download</a>
      </div>
      <button class="lb-btn lb-next" aria-label="Next">›</button>
    </div>

    <footer class="site-footer">
      <span id="generatedAt"></span>
    </footer>

    <script src="./main.js"></script>
    <script>
      function getParam(name) {
        const p = new URLSearchParams(location.search);
        return p.get(name);
      }

      window.addEventListener('DOMContentLoaded', async () => {
        try {
          const data = await window.PhotoShare.loadManifest();
          const id = (getParam('g') || '').trim();
          // Try to find by id first, then by name as a fallback (helps if ids/names mismatch)
          let group = (data && Array.isArray(data.groups)) ? data.groups.find(x => x.id === id) : null;
          if (!group && data && Array.isArray(data.groups)) {
            group = data.groups.find(x => x.name === id);
          }

          const photosEl = document.getElementById('photos');
          const emptyEl = document.getElementById('emptyState');
          const titleEl = document.getElementById('groupTitle');
          const crumbEl = document.getElementById('groupCrumb');
          const genEl = document.getElementById('generatedAt');

          if (!group) {
            if (emptyEl) emptyEl.hidden = false;
            if (genEl) genEl.textContent = '';
            return;
          }

          if (titleEl) titleEl.textContent = group.name || id;
          if (crumbEl) crumbEl.textContent = group.name || id;
          if (genEl) genEl.textContent = data.generatedAt ? `Updated: ${data.generatedAt}` : '';

          if (!photosEl) {
            // If container is missing, show empty state rather than crash
            if (emptyEl) emptyEl.hidden = false;
            return;
          }

          // Build photo grid using thumbnails when available
          for (let i = 0; i < (group.photos || []).length; i++) {
            const p = group.photos[i];
            const t = (group.thumbs && group.thumbs[i]) ? group.thumbs[i] : p;
            const card = document.createElement('div');
            card.className = 'photo-card';

            const a = document.createElement('a');
            a.href = `../${p}`;
            a.rel = 'noopener';
            a.addEventListener('click', (e) => {
              e.preventDefault();
              openLightbox(i);
            });

            const img = document.createElement('img');
            img.loading = 'lazy';
            img.alt = group.name || '';
            img.src = `../${t}`;

            const bar = document.createElement('div');
            bar.className = 'photo-bar';

            const name = document.createElement('span');
            name.className = 'photo-name';
            name.textContent = p.split('/').slice(-1)[0];

            const dl = document.createElement('a');
            dl.href = `../${p}`;
            dl.download = '';
            dl.className = 'download';
            dl.textContent = 'Download';

            a.appendChild(img);
            bar.appendChild(name);
            bar.appendChild(dl);
            card.appendChild(a);
            card.appendChild(bar);
            photosEl.appendChild(card);
          }
          // Lightbox setup
          const lb = document.getElementById('lightbox');
          const lbImg = document.getElementById('lightboxImage');
          const lbName = document.getElementById('lbName');
          const lbDl = document.getElementById('lbDownload');
          const btnPrev = document.querySelector('.lb-prev');
          const btnNext = document.querySelector('.lb-next');
          const btnClose = document.querySelector('.lb-close');

          let idx = 0;
          function show(i){
            idx = (i + group.photos.length) % group.photos.length;
            const full = group.photos[idx];
            lbImg.src = `../${full}`;
            lbName.textContent = full.split('/').slice(-1)[0];
            lbDl.href = `../${full}`;
          }
          window.openLightbox = (i) => {
            lb.hidden = false;
            document.body.style.overflow = 'hidden';
            show(i);
          };
          function closeLb(){
            lb.hidden = true;
            document.body.style.overflow = '';
            lbImg.src = '';
          }
          btnPrev.addEventListener('click', () => show(idx - 1));
          btnNext.addEventListener('click', () => show(idx + 1));
          btnClose.addEventListener('click', closeLb);
          lb.addEventListener('click', (e) => { if (e.target === lb) closeLb(); });
          window.addEventListener('keydown', (e) => {
            if (lb.hidden) return;
            if (e.key === 'Escape') closeLb();
            if (e.key === 'ArrowLeft') show(idx - 1);
            if (e.key === 'ArrowRight') show(idx + 1);
          });

        } catch (err) {
          console.error('Error rendering group page:', err);
          const emptyEl = document.getElementById('emptyState');
          if (emptyEl) emptyEl.hidden = false;
        }
      });
    </script>
  </body>
  </html>
