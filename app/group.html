<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Carson's Photos</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="site-header">
      <h1 class="site-title"><a href="index.html">Carson's Photos</a></h1>
      <nav class="site-nav">
        <span id="groupCrumb" class="crumb"></span>
      </nav>
    </header>

    <main class="container">
      <div class="toolbar">
        <button id="btnSelect" class="btn">Select</button>
        <div id="selectActions" class="actions" hidden>
          <button id="btnCancel" class="btn">Cancel</button>
          <button id="btnSelectAll" class="btn">Select All</button>
          <button id="btnShare" class="btn" disabled>Share Selected (0)</button>
          <button id="btnDownload" class="btn primary" disabled>Download Selected (0)</button>
        </div>
      </div>
      <section>
        <h2 id="groupTitle" class="section-title"></h2>
        <div id="photos" class="grid photos-grid" aria-live="polite"></div>
        <div id="emptyState" class="empty" hidden>
          <p>Album not found or has no photos.</p>
        </div>
      </section>
    </main>

    <div id="lightbox" class="lightbox" hidden>
      <button class="lb-btn lb-close" aria-label="Close">×</button>
      <button class="lb-btn lb-prev" aria-label="Previous">‹</button>
      <img id="lightboxImage" alt="Full size" />
      <button class="lb-btn lb-next" aria-label="Next">›</button>
    </div>

    <footer class="site-footer">
      <span id="generatedAt"></span>
    </footer>

    <script src="./main.js"></script>
    <script>
      function getParam(name) {
        const p = new URLSearchParams(location.search);
        return p.get(name);
      }

      window.addEventListener('DOMContentLoaded', async () => {
        try {
          const data = await window.PhotoShare.loadManifest();
          const id = (getParam('g') || '').trim();
          // Try to find by id first, then by name as a fallback (helps if ids/names mismatch)
          let group = (data && Array.isArray(data.groups)) ? data.groups.find(x => x.id === id) : null;
          if (!group && data && Array.isArray(data.groups)) {
            group = data.groups.find(x => x.name === id);
          }

          const photosEl = document.getElementById('photos');
          const emptyEl = document.getElementById('emptyState');
          const titleEl = document.getElementById('groupTitle');
          const crumbEl = document.getElementById('groupCrumb');
          const genEl = document.getElementById('generatedAt');

          if (!group) {
            if (emptyEl) emptyEl.hidden = false;
            if (genEl) genEl.textContent = '';
            return;
          }

          if (titleEl) titleEl.textContent = group.name || id;
          if (crumbEl) crumbEl.textContent = group.name || id;
          if (genEl) genEl.textContent = data.generatedAt ? `Updated: ${data.generatedAt}` : '';

          if (!photosEl) {
            // If container is missing, show empty state rather than crash
            if (emptyEl) emptyEl.hidden = false;
            return;
          }

          // Selection state
          let selectionMode = false;
          const selected = new Set();
          let lastSelectedIndex = null;

          const btnSelect = document.getElementById('btnSelect');
          const actions = document.getElementById('selectActions');
          const btnCancel = document.getElementById('btnCancel');
          const btnSelectAll = document.getElementById('btnSelectAll');
          const btnShare = document.getElementById('btnShare');
          const btnDownload = document.getElementById('btnDownload');
          let shareSupported = false;

          // Detect Web Share (files) support and toggle Share button visibility
          (function detectShareSupport(){
            try{
              if (navigator && 'share' in navigator && 'canShare' in navigator && window.File && window.Blob){
                const f = new File([new Blob(['x'], { type: 'image/jpeg' })], 'x.jpg', { type: 'image/jpeg' });
                shareSupported = !!navigator.canShare({ files: [f] });
              } else {
                shareSupported = false;
              }
            } catch { shareSupported = false; }
            if (btnShare){ btnShare.hidden = !shareSupported; }
          })();

          function updateToolbar(){
            const count = selected.size;
            btnDownload.textContent = `Download Selected (${count})`;
            btnDownload.disabled = count === 0;
            if (btnShare){
              btnShare.textContent = `Share Selected (${count})`;
              btnShare.disabled = count === 0;
            }
          }

          function enterSelect(){
            if (selectionMode) return;
            selectionMode = true;
            document.body.classList.add('select-mode');
            btnSelect.hidden = true;
            actions.hidden = false;
          }
          function exitSelect(){
            selectionMode = false;
            document.body.classList.remove('select-mode');
            btnSelect.hidden = false;
            actions.hidden = true;
            selected.clear();
            lastSelectedIndex = null;
            // Clear visual state
            document.querySelectorAll('.photo-card.selected').forEach(el=>el.classList.remove('selected'));
            updateToolbar();
          }

          btnSelect.addEventListener('click', enterSelect);
          btnCancel.addEventListener('click', exitSelect);
          btnSelectAll.addEventListener('click', ()=>{
            selected.clear();
            for (let i=0;i<group.photos.length;i++){ selected.add(i); }
            document.querySelectorAll('.photo-card').forEach(el=>el.classList.add('selected'));
            updateToolbar();
          });
          btnDownload.addEventListener('click', ()=>{
            if (selected.size === 0) return;
            const indices = Array.from(selected.values()).sort((a,b)=>a-b);
            let delay = 0;
            for (const i of indices){
              const full = group.photos[i];
              const url = `../${full}`;
              const name = full.split('/').slice(-1)[0];
              setTimeout(()=>{
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                document.body.appendChild(a);
                a.click();
                a.remove();
              }, delay);
              delay += 150; // stagger to improve browser compatibility
            }
          });

          btnShare.addEventListener('click', async ()=>{
            if (!selected.size) return;
            const indices = Array.from(selected.values()).sort((a,b)=>a-b);
            const maxShare = 20; // keep memory reasonable on mobile
            const slice = indices.slice(0, maxShare);
            try{
              const files = [];
              for (const i of slice){
                const full = group.photos[i];
                const url = `../${full}`;
                const name = full.split('/').slice(-1)[0];
                const res = await fetch(url, { cache:'no-store' });
                const blob = await res.blob();
                const type = blob.type || 'image/jpeg';
                files.push(new File([blob], name, { type }));
              }
              if (navigator.canShare && navigator.canShare({ files })){
                await navigator.share({ files, title: group.name || 'Photos' });
              } else {
                // Fallback to downloads
                let delay = 0;
                for (const i of indices){
                  const full = group.photos[i];
                  const url = `../${full}`;
                  const name = full.split('/').slice(-1)[0];
                  setTimeout(()=>{
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = name;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                  }, delay);
                  delay += 150;
                }
              }
            }catch(err){
              console.error('Share failed, falling back to download:', err);
              // Fallback to downloads
              const indices = Array.from(selected.values()).sort((a,b)=>a-b);
              let delay = 0;
              for (const i of indices){
                const full = group.photos[i];
                const url = `../${full}`;
                const name = full.split('/').slice(-1)[0];
                setTimeout(()=>{
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = name;
                  document.body.appendChild(a);
                  a.click();
                  a.remove();
                }, delay);
                delay += 150;
              }
            }
          });

          function setSelected(i, val){
            if (val) selected.add(i); else selected.delete(i);
            const card = document.querySelector(`.photo-card[data-index="${i}"]`);
            if (card) card.classList.toggle('selected', val);
            updateToolbar();
          }

          function toggleSelected(i){
            setSelected(i, !selected.has(i));
          }

          function handleSelectClick(i, e){
            if (e.shiftKey && lastSelectedIndex !== null){
              const start = Math.min(lastSelectedIndex, i);
              const end = Math.max(lastSelectedIndex, i);
              for (let k=start; k<=end; k++){ setSelected(k, true); }
            } else {
              toggleSelected(i);
            }
            lastSelectedIndex = i;
          }

          // Build photo grid using thumbnails when available
          for (let i = 0; i < (group.photos || []).length; i++) {
            const p = group.photos[i];
            const t = (group.thumbs && group.thumbs[i]) ? group.thumbs[i] : p;
            const card = document.createElement('div');
            card.className = 'photo-card';
            card.dataset.index = String(i);

            const a = document.createElement('a');
            a.href = `../${p}`;
            a.rel = 'noopener';
            a.addEventListener('click', (e) => {
              if (selectionMode) {
                e.preventDefault();
                handleSelectClick(i, e);
              } else {
                e.preventDefault();
                openLightbox(i);
              }
            });

            const img = document.createElement('img');
            img.loading = 'lazy';
            img.alt = group.name || '';
            img.src = `../${t}`;

            a.appendChild(img);
            card.appendChild(a);
            photosEl.appendChild(card);
          }
          // Lightbox setup
          const lb = document.getElementById('lightbox');
          const lbImg = document.getElementById('lightboxImage');
          const btnPrev = document.querySelector('.lb-prev');
          const btnNext = document.querySelector('.lb-next');
          const btnClose = document.querySelector('.lb-close');

          let idx = 0;
          function show(i){
            idx = (i + group.photos.length) % group.photos.length;
            const full = group.photos[idx];
            lbImg.src = `../${full}`;
          }
          window.openLightbox = (i) => {
            lb.hidden = false;
            document.body.style.overflow = 'hidden';
            show(i);
          };
          function closeLb(){
            lb.hidden = true;
            document.body.style.overflow = '';
            lbImg.src = '';
          }
          btnPrev.addEventListener('click', () => show(idx - 1));
          btnNext.addEventListener('click', () => show(idx + 1));
          btnClose.addEventListener('click', closeLb);
          lb.addEventListener('click', (e) => { if (e.target === lb) closeLb(); });
          window.addEventListener('keydown', (e) => {
            if (lb.hidden) return;
            if (e.key === 'Escape') closeLb();
            if (e.key === 'ArrowLeft') show(idx - 1);
            if (e.key === 'ArrowRight') show(idx + 1);
          });

        } catch (err) {
          console.error('Error rendering group page:', err);
          const emptyEl = document.getElementById('emptyState');
          if (emptyEl) emptyEl.hidden = false;
        }
      });
    </script>
  </body>
  </html>
